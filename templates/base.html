<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}CGA System{% endblock %}</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { prompt: ['Prompt', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { 500: '#2563eb', 600:'#1d4ed8' } }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ß‡πá‡∏ö */
  html {
    font-size: 18px;             /* ‡πÄ‡∏î‡∏¥‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 16px ‚Üí ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ß‡πá‡∏ö */
  }
  body {
    font-family: 'Prompt', ui-sans-serif, system-ui;
    font-size: 1.05rem;          /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
    line-height: 1.7;            /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
  }

  /* ‡∏ü‡∏≠‡∏£‡πå‡∏° / ‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏° */
  input,
  select,
  textarea,
  button {
    font-size: 1rem;
  }

  label {
    font-size: 1rem;
  }

  /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å radio/checkbox ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
  input[type="radio"],
  input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô text-xs / text-sm ‡∏à‡∏≤‡∏Å Tailwind ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πá‡∏Å‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
  .text-xs {
    font-size: 0.9rem;   /* ‡πÄ‡∏î‡∏¥‡∏° ~0.75rem */
  }
  .text-sm {
    font-size: 0.95rem;  /* ‡πÄ‡∏î‡∏¥‡∏° ~0.875rem */
  }

  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î radio button ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
input[type="radio"] {
    width: 22px;
    height: 22px;
    transform: scale(1.25); /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏° */
    cursor: pointer;
}

/* ‡∏à‡∏±‡∏î label ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
label.mmse-option-big,
label.flex-big {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s ease;
}

/* hover = ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏î‡πâ */
label.mmse-option-big:hover,
label.flex-big:hover {
    background: #eef2ff;  /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ */
.mmse-option-group {
    display: flex;
    gap: 20px;  /* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
    margin-top: 8px;
}
</style>
</head>
<body class="min-h-screen bg-[radial-gradient(1200px_600px_at_70%_10%,#eaf3ff,transparent),radial-gradient(800px_400px_at_30%_90%,#eefaff,transparent)]">

  {% block content %}{% endblock %}

  <!-- üîµ Floating AI Chat Bubble -->
  <div id="ai-chat-bubble"
       class="fixed bottom-6 right-6 z-40">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏° ‡πÜ -->
    <button id="ai-chat-toggle"
            class="w-14 h-14 rounded-full bg-blue-600 text-white shadow-xl
                   flex items-center justify-center text-2xl
                   hover:bg-blue-700 focus:outline-none">
      üí¨
    </button>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó -->
    <div id="ai-chat-panel"
         class="hidden mt-3 w-80 md:w-96 h-96 rounded-2xl shadow-2xl bg-white border border-slate-200 flex flex-col overflow-hidden">
      <!-- ‡∏´‡∏±‡∏ß -->
      <div class="px-4 py-2 bg-blue-600 text-white flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold">AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
          <div id="ai-chat-subtitle" class="text-xs opacity-80">
            ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
          </div>
        </div>
        <button id="ai-chat-close" class="text-xl leading-none">&times;</button>
      </div>

      <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏ä‡∏ó -->
      <div id="ai-chat-messages"
           class="flex-1 px-3 py-2 overflow-y-auto bg-slate-50 text-sm space-y-2">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
        <div class="flex">
          <div class="max-w-[80%] rounded-2xl rounded-bl-none bg-white border border-slate-200 px-3 py-2">
            ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ üëã ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </div>
        </div>
      </div>

      <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå -->
      <form id="ai-chat-form" class="border-t border-slate-200 flex items-center gap-2 px-2 py-2">
        <input id="ai-chat-input"
               type="text"
               placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á AI..."
               class="flex-1 border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
        <button type="submit"
                class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">
          ‡∏™‡πà‡∏á
        </button>
      </form>
    </div>
  </div>

  <!-- JS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chat Bubble -->
  <script>
    const bubbleToggle = document.getElementById('ai-chat-toggle');
    const bubblePanel  = document.getElementById('ai-chat-panel');
    const bubbleClose  = document.getElementById('ai-chat-close');
    const chatForm     = document.getElementById('ai-chat-form');
    const chatInput    = document.getElementById('ai-chat-input');
    const chatMessages = document.getElementById('ai-chat-messages');
    const chatSubtitle = document.getElementById('ai-chat-subtitle');

    function getAiContext() {
      const el = document.getElementById('ai-context');
      if (!el) return {};
      return {
        hn: el.dataset.hn || null,
        gcn: el.dataset.gcn || null,
        name: el.dataset.name || null,
        page: el.dataset.page || document.title || null,
      };
    }

    function updateSubtitleFromContext() {
      const ctx = getAiContext();
      if (ctx.name) {
        chatSubtitle.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${ctx.name} (${ctx.hn || '-'} / ${ctx.gcn || '-'})`;
      } else {
        chatSubtitle.textContent = '‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
      }
    }

    function openChat() {
      bubblePanel.classList.remove('hidden');
      updateSubtitleFromContext();
      chatInput.focus();
    }
    function closeChat() {
      bubblePanel.classList.add('hidden');
    }

    bubbleToggle.addEventListener('click', () => {
      if (bubblePanel.classList.contains('hidden')) {
        openChat();
      } else {
        closeChat();
      }
    });

    bubbleClose.addEventListener('click', closeChat);

    // helper ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
    function appendMessage(text, from = 'user') {
      const wrapper = document.createElement('div');
      wrapper.className = from === 'user' ? 'flex justify-end' : 'flex';

      const bubble = document.createElement('div');
      bubble.className =
        from === 'user'
          ? 'max-w-[80%] rounded-2xl rounded-br-none bg-blue-600 text-white px-3 py-2 text-sm whitespace-pre-line'
          : 'max-w-[80%] rounded-2xl rounded-bl-none bg-white border border-slate-200 px-3 py-2 text-sm whitespace-pre-line';
      bubble.textContent = text;

      wrapper.appendChild(bubble);
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ backend
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      appendMessage(text, 'user');
      chatInput.value = '';

      const ctx = getAiContext();

      try {
        const res = await fetch('/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, context: ctx })
        });
        const data = await res.json();
        appendMessage(data.reply || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ', 'ai');
      } catch (err) {
        appendMessage('‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'ai');
      }
    });
  </script>
</body>
</html>
