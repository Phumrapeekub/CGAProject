{% extends "doctor/medical_base.html" %}

{% block title %}ข้อมูลผู้ป่วย (Medical Dashboard 2025){% endblock %}

{% block head %}
<style>
  #global-back-wrapper { display:none; }

  /* Sleek scrollbar */
  .scroller::-webkit-scrollbar { width: 10px; height: 10px; }
  .scroller::-webkit-scrollbar-track { background: rgba(241,245,249,.85); border-radius: 999px; }
  .scroller::-webkit-scrollbar-thumb { background-color: rgba(148,163,184,.65); border-radius: 999px; border: 2px solid rgba(241,245,249,.85); }
  .scroller::-webkit-scrollbar-thumb:hover { background-color: rgba(100,116,139,.9); }

  /* Smooth details */
  summary::-webkit-details-marker { display:none; }

  /* ===============  "Blend" UI (no hard frames)  =============== */
  .surface{
    background: rgba(255,255,255,.72);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(226,232,240,.0);
    box-shadow: 0 10px 28px rgba(2,6,23,.05);
    border-radius: 26px;
  }
  .surface-plain{
    background: transparent;
    border: 0;
    box-shadow: none;
    border-radius: 0;
  }
  .surface-head{
    background: rgba(248,250,252,.65);
    border-bottom: 1px solid rgba(226,232,240,.55);
  }
  .soft-divider{
    border-top: 1px solid rgba(226,232,240,.55);
  }

  /* ลดความรู้สึก "มีกรอบ" ของชิ้นย่อย */
  .soft-chip{ background: rgba(248,250,252,.9); border: 1px solid rgba(226,232,240,.6); }

  /* ✅ ลบ/ไม่ใช้ EMBED RESET แล้ว เพราะทำให้ข้อมูลด้านใน (partial) หาย/พัง */
</style>
{% endblock %}

{% block content %}

{# -------------------------
   SAFE GETTERS / FALLBACKS
-------------------------- #}
{% set p = patients or {} %}
{% set g = cga_general or {} %}

{% if visits is defined and visits %}
  {% set _visits = visits %}
{% elif visit is defined and visit %}
  {% set _visits = visit %}
{% else %}
  {% set _visits = [] %}
{% endif %}

{% if upcoming_appts is defined and upcoming_appts %}
  {% set _upcoming = upcoming_appts %}
{% elif upcoming is defined and upcoming %}
  {% set _upcoming = upcoming %}
{% else %}
  {% set _upcoming = [] %}
{% endif %}

{% set hn  = (p.get('hn') if p is mapping else (p.hn if p.hn is defined else '')) %}
{% set gcn = (p.get('gcn') if p is mapping else (p.gcn if p.gcn is defined else '')) %}

{% set p_name = (p.get('name') if p is mapping else (p.name if p.name is defined else '')) %}
{% if not p_name %}
  {% set _fn = p.get('first_name','') if p is mapping else (p.first_name if p.first_name is defined else '') %}
  {% set _ln = p.get('last_name','') if p is mapping else (p.last_name if p.last_name is defined else '') %}
  {% set p_name = (_fn ~ ' ' ~ _ln)|trim %}
{% endif %}

{% set p_age = (p.get('age') if p is mapping else (p.age if p.age is defined else None)) %}
{% set p_gender = (p.get('gender_th') if p is mapping else (p.gender_th if p.gender_th is defined else None)) %}
{% set _avatar = (p_name|string)[:1] if p_name else 'U' %}

{# Scores #}
{% set mmse = (scores.mmse if scores is defined and scores and scores.mmse is defined else (scores.get('mmse') if scores is mapping else 0)) %}
{% set tgds = (scores.tgds if scores is defined and scores and scores.tgds is defined else (scores.get('tgds') if scores is mapping else 0)) %}
{% set sra  = (scores.sra  if scores is defined and scores and scores.sra  is defined else (scores.get('sra')  if scores is mapping else 0)) %}
{% set twoq = (scores.twoq if scores is defined and scores and scores.twoq is defined else (scores.get('twoq') if scores is mapping else 0)) %}

<div class="min-h-[calc(100vh-64px)] bg-slate-50">
  <div class="max-w-[1200px] mx-auto px-4 lg:px-6 py-6">

    <!-- ===== Top bar (same page / no extra footer block) ===== -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div class="min-w-0">
        <div class="text-slate-100 text-sm">รายละเอียดผู้ป่วย</div>
        <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight truncate">
          {{ p_name or 'ไม่ระบุชื่อ' }}
          <span class="ml-2 text-sm font-bold text-slate-500">HN: {{ hn }}</span>
        </h1>
      </div>

      <div class="flex items-center gap-3">
        <a href="/doctor/patients"
           class="inline-flex items-center justify-center px-5 py-2.5 rounded-2xl bg-white/80 hover:bg-white font-extrabold text-slate-700 shadow-sm border border-slate-200/60">
          กลับหน้ารายชื่อ
        </a>

        <a href="{{ url_for('doctor_dashboard') }}"
           class="inline-flex items-center justify-center px-5 py-2.5 rounded-2xl bg-slate-900 text-white hover:bg-black font-extrabold shadow-sm">
          กลับหน้าหลัก
        </a>
      </div>
    </div>

    <!-- ===== Main grid (no outer card frame) ===== -->
    <div class="grid grid-cols-12 gap-6">

      <!-- ========= Profile ========= -->
      <section class="col-span-12 surface p-5">
        <div class="flex flex-col sm:flex-row gap-4 sm:items-center">
          <div class="shrink-0">
            <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-indigo-500 via-violet-600 to-fuchsia-600 text-white flex items-center justify-center text-2xl font-extrabold shadow-lg shadow-indigo-200/60">
              {{ _avatar }}
            </div>
          </div>

          <div class="min-w-0 flex-1">
            <div class="text-lg font-extrabold text-slate-900">ประวัติส่วนตัว</div>
            <div class="mt-1 text-sm text-slate-500 flex flex-wrap gap-3">
              <span class="inline-flex items-center gap-1.5">
                <span class="font-bold text-slate-700">อายุ:</span> {{ p_age if p_age else '-' }} ปี
              </span>
              <span class="inline-flex items-center gap-1.5">
                <span class="font-bold text-slate-700">เพศ:</span> {{ p_gender or '-' }}
              </span>
              <span class="inline-flex items-center gap-1.5">
                <span class="font-bold text-slate-700">โทร:</span> {{ (p.get('phone') if p is mapping else (p.phone if p.phone is defined else None)) or "-" }}
              </span>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="rounded-2xl soft-chip p-3">
                <div class="text-[11px] text-slate-500 font-bold">ที่อยู่</div>
                <div class="text-sm font-bold text-slate-800 mt-1 leading-relaxed">{{ p.get('address') or '-' }}</div>
              </div>
              <div class="rounded-2xl soft-chip p-3">
                <div class="text-[11px] text-slate-500 font-bold">การพักอาศัย</div>
                <div class="text-sm font-bold text-slate-800 mt-1">
                  {% if g.get('living_status') == 'alone' %}อยู่คนเดียว
                  {% elif g.get('living_status') == 'family' %}อยู่กับครอบครัว
                  {% else %}-{% endif %}
                </div>
              </div>
              <div class="rounded-2xl bg-white/85 border border-slate-200/70 p-3">
                <div class="text-[11px] text-slate-500 font-bold">ผู้ดูแล (Caregiver)</div>
                <div class="text-sm font-bold text-slate-800 mt-1">
                  {{ g.get('caregiver_name') or 'ไม่มีข้อมูล' }}
                  {% if g.get('caregiver_phone') %}
                    <span class="text-slate-500 font-semibold">({{ g.get('caregiver_phone') }})</span>
                  {% endif %}
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- ========= CGA Forms ========= -->
      <section class="col-span-12 lg:col-span-8 surface overflow-hidden">
        <div class="surface-head px-5 py-4 flex items-center justify-between">
          <div class="font-extrabold text-slate-900">แบบฟอร์ม CGA ทั้งหมด</div>
          <div class="text-[11px] text-slate-400 font-bold">แสดงฟอร์มจริงในหน้า (2025 UI)</div>
        </div>

        <div class="h-[420px] overflow-y-auto scroller p-5 space-y-4">

          <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
            <div class="text-sm font-extrabold text-slate-900 mb-2">1. การสูบบุหรี่</div>
            {% set smoke = g.get('smoking_status') %}
            <div class="flex flex-wrap gap-2">
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if smoke=='yes' %}bg-rose-50 border-rose-200 text-rose-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">สูบ</span>
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if smoke=='no' %}bg-emerald-50 border-emerald-200 text-emerald-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">ไม่สูบ</span>
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if smoke=='quit' %}bg-amber-50 border-amber-200 text-amber-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">เคยสูบ/เลิกแล้ว</span>
            </div>
            {% if smoke=='yes' %}
              <div class="mt-2 text-sm text-slate-600">จำนวน: <span class="font-extrabold">{{ g.get('smoking_per_day') or '-' }}</span> มวน/วัน</div>
            {% endif %}
          </div>

          <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
            <div class="text-sm font-extrabold text-slate-900 mb-2">2. ดื่มแอลกอฮอล์</div>
            {% set alc = g.get('alcohol_level') %}
            <div class="flex flex-wrap gap-2">
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if alc=='never' %}bg-emerald-50 border-emerald-200 text-emerald-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">ไม่เคยดื่ม</span>
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if alc=='sometimes' %}bg-amber-50 border-amber-200 text-amber-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">ดื่มบางครั้ง</span>
              <span class="px-3 py-1 rounded-full text-sm border font-bold {% if alc=='daily' %}bg-rose-50 border-rose-200 text-rose-700{% else %}bg-slate-50 border-slate-200 text-slate-400{% endif %}">ดื่มทุกวัน</span>
            </div>
          </div>

          <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
            <div class="text-sm font-extrabold text-slate-900 mb-3">3. ส่วนสูงและรอบเอว</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-2xl bg-slate-50/90 border border-slate-200/50 p-4 text-center">
                <div class="text-[11px] text-slate-500 font-bold">ส่วนสูง (ซม.)</div>
                <div class="text-2xl font-extrabold text-slate-900 mt-1">{{ g.get('height') or '-' }}</div>
              </div>
              <div class="rounded-2xl bg-slate-50/90 border border-slate-200/50 p-4 text-center">
                <div class="text-[11px] text-slate-500 font-bold">รอบเอว (ซม.)</div>
                <div class="text-2xl font-extrabold text-slate-900 mt-1">{{ g.get('waist') or '-' }}</div>
              </div>
            </div>
          </div>

          <!-- MMSE -->
          <div class="rounded-3xl overflow-hidden bg-white/85 border border-indigo-200/50">
            <div class="bg-gradient-to-r from-indigo-50/80 to-violet-50/70 p-4 flex items-center justify-between">
              <div class="text-sm font-extrabold text-indigo-950">7. สมรรถภาพสมอง (MMSE-T 2002)</div>
              <span class="text-xs bg-white/90 text-indigo-700 px-2.5 py-1 rounded-xl border border-indigo-200/60 font-extrabold">เต็ม 30</span>
            </div>

            <div class="p-4">
              <div class="flex items-center justify-between">
                <span class="text-sm text-slate-600 font-bold">คะแนนรวม</span>
                <span class="text-3xl font-extrabold {% if mmse < 24 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                  {{ mmse }} <span class="text-sm font-bold text-slate-400">/30</span>
                </span>
              </div>

              <details class="mt-4 group rounded-2xl bg-indigo-50/50 border border-indigo-200/50 overflow-hidden">
                <summary class="cursor-pointer list-none px-4 py-3 flex items-center justify-between">
                  <span class="text-sm font-extrabold text-indigo-900">แสดงแบบฟอร์ม MMSE (จากไฟล์)</span>
                  <span class="text-indigo-700 font-extrabold group-open:rotate-180 transition">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </span>
                </summary>
                <div class="p-4 bg-white/80 soft-divider">
                  {# ✅ คืน partial ให้แสดงเต็ม ไม่ครอบ embed-plain #}
                  {% include "assess/mmse_form_partial.html" %}
                </div>
              </details>
            </div>
          </div>

          <!-- Depression block -->
          <div class="rounded-3xl overflow-hidden bg-white/85 border border-fuchsia-200/50">
            <div class="bg-gradient-to-r from-fuchsia-50/80 to-pink-50/70 p-4">
              <div class="text-sm font-extrabold text-fuchsia-950">10. ภาวะซึมเศร้า & ฆ่าตัวตาย</div>
            </div>

            <div class="p-4 space-y-4">

              <!-- 2Q -->
              <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-extrabold text-slate-800">2Q</span>
                  <span class="text-sm font-extrabold {% if twoq > 0 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                    {{ 'เสี่ยง' if twoq > 0 else 'ปกติ' }} ({{ twoq }}/2)
                  </span>
                </div>

                <details class="mt-3 group rounded-2xl bg-slate-50/80 border border-slate-200/60 overflow-hidden">
                  <summary class="cursor-pointer list-none px-4 py-3 flex items-center justify-between">
                    <span class="text-sm font-extrabold text-slate-700">แสดงแบบฟอร์ม 2Q (จากไฟล์)</span>
                    <span class="text-slate-600 font-extrabold group-open:rotate-180 transition">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </span>
                  </summary>
                  <div class="p-4 bg-white/80 soft-divider">
                    {% include "assess/twoq_form_partial.html" %}
                  </div>
                </details>
              </div>

              <!-- TGDS -->
              <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-extrabold text-slate-800">TGDS-15</span>
                  <span class="text-sm font-extrabold {% if tgds >= 6 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                    {{ tgds }} / 15
                  </span>
                </div>

                <details class="mt-3 group rounded-2xl bg-slate-50/80 border border-slate-200/60 overflow-hidden">
                  <summary class="cursor-pointer list-none px-4 py-3 flex items-center justify-between">
                    <span class="text-sm font-extrabold text-slate-700">แสดงแบบฟอร์ม TGDS-15 (จากไฟล์)</span>
                    <span class="text-slate-600 font-extrabold group-open:rotate-180 transition">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </span>
                  </summary>
                  <div class="p-4 bg-white/80 soft-divider">
                    {% include "assess/tgds15_form_partial.html" %}
                  </div>
                </details>
              </div>

              <!-- 8Q -->
              <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-extrabold text-slate-800">8Q (SRA)</span>
                  <span class="text-sm font-extrabold {% if sra > 0 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                    {{ sra }} / 24
                  </span>
                </div>

                <details class="mt-3 group rounded-2xl bg-slate-50/80 border border-slate-200/60 overflow-hidden">
                  <summary class="cursor-pointer list-none px-4 py-3 flex items-center justify-between">
                    <span class="text-sm font-extrabold text-slate-700">แสดงแบบฟอร์ม 8Q (จากไฟล์)</span>
                    <span class="text-slate-600 font-extrabold group-open:rotate-180 transition">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </span>
                  </summary>
                  <div class="p-4 bg-white/80 soft-divider">
                    {% include "assess/8q_form_partial.html" %}
                  </div>
                </details>
              </div>

            </div>
          </div>

        </div>
      </section>

      <!-- ========= AI Summary (keep as strong card) ========= -->
      <section class="col-span-12 lg:col-span-4 overflow-hidden rounded-[26px] bg-gradient-to-br from-slate-900 to-indigo-900 shadow-lg">
        <div class="p-5 text-white">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-white/15 border border-white/10 flex items-center justify-center">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wider text-white/70 font-extrabold">AI</div>
              <div class="text-lg font-extrabold">สรุปความเสี่ยง</div>
            </div>
          </div>

          <div class="mt-4 rounded-2xl bg-white/10 border border-white/10 p-4">
            <div class="text-sm text-white/90 leading-relaxed">
              ผู้ป่วยมีความเสี่ยงด้าน <span class="font-extrabold">Cognitive (MMSE &lt; 24)</span> และมีความเสี่ยงหกล้มสูง
              แนะนำติดตาม CGA ต่อเนื่อง และพิจารณาส่งต่อคลินิกความจำ
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-2xl bg-white/10 border border-white/10 p-3">
                <div class="text-[11px] text-white/70 font-extrabold">MMSE</div>
                <div class="text-2xl font-extrabold mt-1">{{ mmse }}/30</div>
              </div>
              <div class="rounded-2xl bg-white/10 border border-white/10 p-3">
                <div class="text-[11px] text-white/70 font-extrabold">TGDS</div>
                <div class="text-2xl font-extrabold mt-1">{{ tgds }}/15</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========= Diagnosis ========= -->
      <section class="col-span-12 lg:col-span-6 surface overflow-hidden">
        <div class="surface-head px-5 py-4 flex items-center justify-between">
          <div class="font-extrabold text-slate-900">บันทึกวินิจฉัย</div>
          <div class="text-[11px] text-slate-400 font-bold">โน้ต</div>
        </div>

        <div class="p-5">
          <form method="post" action="/doctor/patient/{{ hn }}/{{ gcn }}/visit/create" class="space-y-3">
            <input type="hidden" name="status" value="closed">

            <div class="hidden">
              <input type="datetime-local" name="visit_datetime" id="quick_visit_datetime" required>
            </div>
            <script>
              const now = new Date();
              now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
              const el = document.getElementById('quick_visit_datetime');
              if (el) el.value = now.toISOString().slice(0,16);
            </script>

            <input type="text" name="chief_complaint" placeholder="อาการสำคัญ (Chief Complaint)..." required
                   class="w-full text-sm bg-white/80 border border-slate-200/70 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">

            <textarea name="note" rows="5" placeholder="บันทึกผลการตรวจ / วินิจฉัย / การรักษา..."
                      class="w-full text-sm bg-white/80 border border-slate-200/70 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>

            <div class="flex justify-end">
              <button type="submit"
                      class="px-6 py-2.5 rounded-2xl bg-slate-900 text-white font-extrabold hover:bg-black transition">
                บันทึก
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- ========= Diagnosis History ========= -->
      <section class="col-span-12 lg:col-span-6 surface overflow-hidden">
        <div class="surface-head px-5 py-4">
          <div class="font-extrabold text-slate-900">ประวัติบันทึกวินิจฉัย</div>
        </div>

        <div class="h-[260px] overflow-y-auto scroller p-4 space-y-3">
          {% if _visits and _visits|length > 0 %}
            {% for v in _visits %}
              <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4 hover:bg-white transition">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="font-extrabold text-slate-900 text-sm truncate">
                      {{ v.chief_complaint or v.reason or 'บันทึกการตรวจ' }}
                    </div>
                    <div class="text-xs text-slate-500 font-bold mt-1">
                      {{ v.visit_datetime.strftime("%d/%m/%Y %H:%M") if v.visit_datetime else (v.encounter_datetime.strftime("%d/%m/%Y %H:%M") if v.encounter_datetime else '-') }}
                    </div>
                  </div>
                  <span class="text-[11px] px-2.5 py-1 rounded-full bg-slate-100/80 border border-slate-200/60 text-slate-600 font-extrabold">
                    {{ v.status or 'Done' }}
                  </span>
                </div>

                {% if v.note %}
                  <div class="mt-2 text-sm text-slate-700 leading-relaxed line-clamp-3">
                    {{ v.note }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-10 text-slate-400 font-semibold">ยังไม่มีประวัติบันทึกวินิจฉัย</div>
          {% endif %}
        </div>
      </section>

      <!-- ========= CGA History ========= -->
      <section class="col-span-12 lg:col-span-6 surface overflow-hidden">
        <div class="surface-head px-5 py-4">
          <div class="font-extrabold text-slate-900">ประวัติ การประเมิน CGA</div>
        </div>

        <div class="h-[220px] overflow-y-auto scroller p-4 space-y-3">
          {% if _visits and _visits|length > 0 %}
            {% for v in _visits %}
              <div class="rounded-2xl bg-white/80 border border-slate-200/60 p-4">
                <div class="flex items-center justify-between gap-3">
                  <div class="min-w-0">
                    <div class="font-extrabold text-slate-900 text-sm truncate">
                      CGA Visit #{{ v.id if v.id is defined else loop.index }}
                    </div>
                    <div class="text-xs text-slate-500 font-bold mt-1">
                      {{ v.visit_datetime.strftime("%d/%m/%Y %H:%M") if v.visit_datetime else (v.encounter_datetime.strftime("%d/%m/%Y %H:%M") if v.encounter_datetime else '-') }}
                    </div>
                  </div>
                  <div class="text-xs font-extrabold text-indigo-700 bg-indigo-50/80 border border-indigo-200/60 px-2.5 py-1 rounded-full">
                    ดูรายละเอียด
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-10 text-slate-400 font-semibold">ยังไม่มีประวัติการประเมิน CGA</div>
          {% endif %}
        </div>
      </section>

      <!-- ========= Appointments ========= -->
      <section class="col-span-12 lg:col-span-6 surface overflow-hidden">
        <div class="surface-head px-5 py-4 flex items-center justify-between">
          <div class="font-extrabold text-slate-900">นัดหมาย</div>
          <button onclick="openApptModal()"
                  class="px-4 py-2 rounded-2xl bg-white/80 hover:bg-white font-extrabold text-slate-700 shadow-sm border border-slate-200/60 transition">
            + เพิ่มนัดหมาย
          </button>
        </div>

        <div class="h-[220px] overflow-y-auto scroller p-4 space-y-3">
          {% if _upcoming and _upcoming|length > 0 %}
            {% for a in _upcoming %}
              <div class="flex gap-3 p-4 rounded-2xl bg-white/80 border border-slate-200/60 hover:bg-white transition">
                <div class="rounded-2xl bg-slate-50/90 border border-slate-200/50 p-3 min-w-[72px] text-center">
                  <div class="text-[10px] text-slate-400 font-extrabold uppercase">
                    {{ a.appt_datetime.strftime("%b") if a.appt_datetime else '-' }}
                  </div>
                  <div class="text-2xl font-extrabold text-slate-900">
                    {{ a.appt_datetime.strftime("%d") if a.appt_datetime else '-' }}
                  </div>
                </div>
                <div class="min-w-0 flex-1">
                  <div class="font-extrabold text-slate-900 text-sm truncate">{{ a.reason or 'ติดตามอาการ' }}</div>
                  <div class="text-xs text-slate-500 font-bold mt-1">
                    {{ a.appt_datetime.strftime("%H:%M") if a.appt_datetime else '-' }} น. • {{ a.location or 'OPD' }}
                  </div>
                  <div class="mt-2">
                    <span class="text-[11px] px-2.5 py-1 rounded-full bg-slate-100/80 border border-slate-200/60 text-slate-600 font-extrabold">
                      {{ a.status or 'Pending' }}
                    </span>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-10 text-slate-400 font-semibold">ไม่มีนัดหมายเร็ว ๆ นี้</div>
          {% endif %}
        </div>
      </section>

    </div>
  </div>
</div>

<!-- ===== Appointment Modal ===== -->
<div id="apptModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeApptModal()"></div>
  <div class="relative mx-auto mt-20 w-[96%] max-w-lg bg-white rounded-3xl shadow-2xl p-6 border border-slate-200">
    <h3 class="font-extrabold text-lg mb-4 text-slate-900">เพิ่มนัดหมาย</h3>
    <form method="post" action="/doctor/patient/{{ hn }}/{{ gcn }}/appointment/create" class="space-y-3">
      <div>
        <label class="text-xs text-slate-500 font-extrabold">วันเวลานัด</label>
        <input type="datetime-local" name="appt_datetime" required
               class="w-full border border-slate-200 rounded-2xl p-3 bg-slate-50">
      </div>
      <div>
        <label class="text-xs text-slate-500 font-extrabold">เรื่อง</label>
        <input type="text" name="reason"
               class="w-full border border-slate-200 rounded-2xl p-3 bg-slate-50">
      </div>
      <div>
        <label class="text-xs text-slate-500 font-extrabold">สถานที่</label>
        <input type="text" name="location"
               class="w-full border border-slate-200 rounded-2xl p-3 bg-slate-50">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeApptModal()"
                class="px-4 py-2 bg-slate-100 rounded-2xl font-extrabold text-slate-700">
          ยกเลิก
        </button>
        <button type="submit"
                class="px-4 py-2 bg-slate-900 text-white rounded-2xl font-extrabold">
          บันทึก
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openApptModal() { document.getElementById("apptModal")?.classList.remove("hidden"); }
  function closeApptModal() { document.getElementById("apptModal")?.classList.add("hidden"); }
</script>

{% endblock %}
