{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow rounded-2xl p-8 mt-8">
  <h2 class="text-2xl font-semibold text-indigo-600 mb-6">
    {% if mode == "add" %}เพิ่มผู้ป่วยใหม่{% else %}แก้ไขข้อมูลผู้ป่วย{% endif %}
  </h2>
  <form method="post" class="grid grid-cols-2 gap-4">
    <input name="hn" placeholder="HN" value="{{ patient.hn if patient else '' }}" class="border rounded-lg px-4 py-2">
    <input name="gcn" placeholder="GCN" value="{{ patient.gcn if patient else '' }}" class="border rounded-lg px-4 py-2">
    <input name="name" placeholder="ชื่อ-นามสกุล" value="{{ patient.name if patient else '' }}" class="col-span-2 border rounded-lg px-4 py-2">
    <input name="age" placeholder="อายุ" value="{{ patient.age if patient else '' }}" class="border rounded-lg px-4 py-2">
    <!-- วันเดือนปีเกิด (พ.ศ.) -->
<div class="col-span-2">
  <label class="block text-gray-700 mb-1">วัน/เดือน/ปีเกิด (พ.ศ.)</label>
  <input 
  type="text"
  id="birthdate"
  name="birthdate_th"
  placeholder="วัน/เดือน/พ.ศ."
  value="{% if patient and patient.birthdate %}{{ patient.birthdate.strftime('%d/%m/') }}{{ patient.birthdate.year + 543 }}{% endif %}"
  class="w-full border rounded-lg px-4 py-2"
/>
  <input type="hidden" id="birthdate_ad" name="birthdate">
</div>
    <select name="gender" class="border rounded-lg px-4 py-2">
      <option value="ชาย" {% if patient and patient.gender == 'ชาย' %}selected{% endif %}>ชาย</option>
      <option value="หญิง" {% if patient and patient.gender == 'หญิง' %}selected{% endif %}>หญิง</option>
    </select>
    <input name="disease" placeholder="โรคประจำตัว" value="{{ patient.disease if patient else '' }}" class="col-span-2 border rounded-lg px-4 py-2">

    <select name="risk_level" class="col-span-2 border rounded-lg px-4 py-2">
      <option value="ต่ำ" {% if patient and patient.risk_level == 'ต่ำ' %}selected{% endif %}>เสี่ยงต่ำ</option>
      <option value="ปานกลาง" {% if patient and patient.risk_level == 'ปานกลาง' %}selected{% endif %}>เสี่ยงปานกลาง</option>
      <option value="สูง" {% if patient and patient.risk_level == 'สูง' %}selected{% endif %}>เสี่ยงสูง</option>
    </select>

    

        {% if mode == 'edit' %}
<!-- ===== ผลการประเมินล่าสุด (ดูคำตอบ + กดแก้ไขได้) ===== -->
<div class="col-span-2 mt-6 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-4">
  <div class="flex items-start justify-between gap-3 mb-3">
    <div>
      <p class="font-semibold text-slate-800">ผลการประเมินล่าสุด</p>
      <p class="text-xs text-slate-500">ดูคำตอบที่เคยกรอก และกดไปแก้ในแบบฟอร์มได้</p>
    </div>

    {% if patient and patient.hn and patient.gcn %}
    <div class="flex gap-2">
      <a href="{{ url_for('mmse_next', hn=patient.hn, gcn=patient.gcn) }}"
         class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700">
        แก้ MMSE
      </a>
      <a href="{{ url_for('affect_step', hn=patient.hn, gcn=patient.gcn) }}"
         class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700">
        แก้ TGDS/SRA
      </a>
    </div>
    {% endif %}
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">

    <!-- MMSE -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4">
      <div class="text-sm font-semibold text-slate-800">MMSE-T</div>
      <div class="text-xs text-slate-500 mt-1">
        คะแนนรวม:
        <span class="font-semibold">
          {{ mmse_detail.total_score if mmse_detail else '-' }}
        </span>
      </div>

      {% if mmse_items and mmse_items|length > 0 %}
      <details class="mt-3">
        <summary class="cursor-pointer text-xs font-medium text-slate-700">
          ดูคำตอบที่ตอบไว้
        </summary>
        <div class="mt-3 grid grid-cols-1 gap-2 text-xs">
          {% for it in mmse_items %}
            <div class="p-2 rounded-xl bg-slate-50 flex items-start justify-between gap-3">
              <div class="text-slate-700">{{ it.label }}</div>
              <div class="font-semibold text-slate-900">{{ it.value }}</div>
            </div>
          {% endfor %}
        </div>
      </details>
      {% else %}
        <div class="mt-3 text-xs text-slate-500">ยังไม่มีข้อมูล</div>
      {% endif %}
    </div>

    <!-- TGDS -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4">
      <div class="text-sm font-semibold text-slate-800">TGDS-15</div>
      <div class="text-xs text-slate-500 mt-1">
        คะแนนรวม:
        <span class="font-semibold">
          {{ tgds_detail.total_score if tgds_detail else '-' }}
        </span>
      </div>

      {% if tgds_items and tgds_items|length > 0 %}
      <details class="mt-3">
        <summary class="cursor-pointer text-xs font-medium text-slate-700">
          ดูคำตอบที่ตอบไว้
        </summary>
        <div class="mt-3 grid grid-cols-1 gap-2 text-xs">
          {% for it in tgds_items %}
            <div class="p-2 rounded-xl bg-slate-50 flex items-start justify-between gap-3">
              <div class="text-slate-700">{{ it.label }}</div>
              <div class="font-semibold text-slate-900">{{ it.value }}</div>
            </div>
          {% endfor %}
        </div>
        <div class="mt-2 text-[11px] text-slate-400">หมายเหตุ: ค่า 1/0 คือ ใช่/ไม่ใช่ (ตามที่เก็บในระบบ)</div>
      </details>
      {% else %}
        <div class="mt-3 text-xs text-slate-500">ยังไม่มีข้อมูล</div>
      {% endif %}
    </div>

    <!-- SRA -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4">
      <div class="text-sm font-semibold text-slate-800">8Q / SRA</div>
      <div class="text-xs text-slate-500 mt-1">
        คะแนนรวม:
        <span class="font-semibold">
          {{ sra_detail.total_score if sra_detail else '-' }}
        </span>
      </div>

      {% if sra_items and sra_items|length > 0 %}
      <details class="mt-3">
        <summary class="cursor-pointer text-xs font-medium text-slate-700">
          ดูคำตอบที่ตอบไว้
        </summary>
        <div class="mt-3 grid grid-cols-1 gap-2 text-xs">
          {% for it in sra_items %}
            <div class="p-2 rounded-xl bg-slate-50 flex items-start justify-between gap-3">
              <div class="text-slate-700">{{ it.label }}</div>
              <div class="font-semibold text-slate-900">{{ it.value }}</div>
            </div>
          {% endfor %}
        </div>
        <div class="mt-2 text-[11px] text-slate-400">หมายเหตุ: ค่า 1/0 คือ มี/ไม่มี (ตามที่เก็บในระบบ)</div>
      </details>
      {% else %}
        <div class="mt-3 text-xs text-slate-500">ยังไม่มีข้อมูล</div>
      {% endif %}
    </div>

  </div>
</div>
{% endif %}




    <div class="col-span-2 flex justify-end gap-3 mt-6">
      <a href="{{ url_for('patient_list') }}" class="px-6 py-2 bg-gray-200 rounded-lg">ยกเลิก</a>
      <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">บันทึก</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("birthdate").addEventListener("input", function () {
    const v = this.value.trim();
    if (!v.includes("/")) return;

    const parts = v.split("/");
    if (parts.length !== 3) return;

    let [d, m, y] = parts.map(x => parseInt(x));

    if (y > 2500) y -= 543; // พ.ศ. → ค.ศ.

    const ad = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

    document.getElementById("birthdate_ad").value = ad;
  });
</script>

{% endblock %}
