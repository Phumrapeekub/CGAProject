{% extends "base.html" %}
{% block title %}‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô {{ patient.name or '' }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[320px,minmax(0,1fr)] gap-6">

  <!-- ========== ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ========== -->
  <div class="space-y-4">
    <div class="rounded-3xl bg-white shadow-lg border border-slate-100 p-6">
      <div class="w-20 h-20 rounded-3xl bg-orange-500/90 grid place-items-center text-4xl mb-4">
        üßë
      </div>

      <div class="font-semibold text-lg mb-1">
        {{ patient.name or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠' }}
      </div>
      <div class="text-sm text-slate-500 mb-4">
        HN / GCN : {{ patient.hn }} / {{ patient.gcn }}
      </div>

      <div class="space-y-3 text-sm text-slate-700">
        <div class="flex items-center gap-2">
          <span class="w-5 text-center">üë§</span>
          <span>
            {{ patient.age or '-' }} ‡∏õ‡∏µ /
            {% if patient.gender == '‡∏ä' %}‡∏ä‡∏≤‡∏¢{% elif patient.gender == '‡∏ç' %}‡∏´‡∏ç‡∏¥‡∏á{% else %}-{% endif %}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-5 text-center">üìû</span>
          <span>{{ patient.phone or '-' }}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-5 text-center">üìå</span>
          <span>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: {{ patient.disease or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-5 text-center">‚ö†Ô∏è</span>
          <span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {{ patient.risk_level or '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' }}</span>
        </div>
      </div>
    </div>

    <a href="{{ url_for('patient_list') }}"
       class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900">
      ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
    </a>
  </div>

  <!-- ========== ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ========== -->
  <div class="space-y-4">

    <!-- ‡πÅ‡∏ñ‡∏ö tab ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
    <div class="rounded-2xl bg-white shadow border border-slate-100 p-1 flex text-sm">
  <a href="{{ url_for('patient_trend', id=patient.id) }}"
     class="flex-1 py-2 text-center rounded-xl text-slate-400 hover:text-slate-700">
    ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
  </a>
  <a href="{{ url_for('patient_history', id=patient.id) }}"
     class="flex-1 py-2 text-center rounded-xl bg-blue-600 text-white font-medium">
    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
  </a>
</div>


    {% if assessments and assessments|length > 0 %}
      {% for a in assessments %}
        <div class="rounded-3xl bg-white shadow-lg border border-slate-100 overflow-hidden">

          <!-- ‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
          <div class="px-6 py-4 flex items-center justify-between bg-slate-50 border-b border-slate-100">
            <div>
              <div class="text-sm text-slate-500">
                {% if a.date_assessed %}
                  {{ a.date_assessed.strftime("%d/%m/%Y") }}
                {% else %}
                  ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                {% endif %}
              </div>
              <div class="text-xs text-slate-400">
                ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢: ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• / ‡∏ó‡∏µ‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
              </div>
            </div>

            <!-- ‚úÖ ‡πÅ‡∏Å‡πâ typo: te‡∏üxt-right -> text-right -->
            <div class="text-right text-sm leading-relaxed">
              <div>
                MMSE:
                <span class="font-semibold text-blue-600">
                  {{ a.mmse or 0 }}/30
                </span>
              </div>
              <div>
                Depression (TGDS-15):
                <span class="font-semibold text-rose-500">
                  {{ a.tgds or 0 }}/15
                </span>
              </div>
              <div class="text-xs text-slate-400 mt-1">
                SRA: <span class="font-semibold text-slate-700">{{ a.sra or 0 }}</span>
              </div>
            </div>
          </div>

          <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô -->
          <div class="px-6 py-5 space-y-4 text-sm">

            <!-- AI Summary -->
            <div class="rounded-2xl bg-violet-50 px-4 py-3">
              <div class="font-semibold text-violet-700 mb-1">AI Summary</div>
              <p class="text-slate-700">
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (Summary) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
              </p>
            </div>
            <!-- üîΩ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
<details class="rounded-2xl bg-slate-50 px-4 py-3">
  <summary class="cursor-pointer font-semibold text-slate-700">
    üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
  </summary>

  <div class="mt-4 space-y-4">

    <!-- MMSE -->
    <div class="rounded-xl bg-white border border-slate-200 p-4">
      <div class="font-semibold mb-2 text-blue-600">MMSE (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</div>
      {% if a.mmse_detail %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
          {% for k, v in a.mmse_detail.items() %}
            {% if k.startswith('q') %}
              <div class="flex justify-between bg-slate-50 rounded-lg px-2 py-1">
                <span class="text-slate-500">{{ k }}</span>
                <span class="font-semibold">{{ v }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MMSE</div>
      {% endif %}
    </div>

    <!-- TGDS -->
    <div class="rounded-xl bg-white border border-slate-200 p-4">
      <div class="font-semibold mb-2 text-rose-500">TGDS-15 (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</div>
      {% if a.tgds_detail %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
          {% for k, v in a.tgds_detail.items() %}
            {% if k.startswith('q') %}
              <div class="flex justify-between bg-slate-50 rounded-lg px-2 py-1">
                <span class="text-slate-500">{{ k }}</span>
                <span class="font-semibold">{{ v }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TGDS</div>
      {% endif %}
    </div>

    <!-- SRA -->
    <div class="rounded-xl bg-white border border-slate-200 p-4">
      <div class="font-semibold mb-2 text-slate-700">SRA (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</div>
      {% if a.sra_detail %}
        <pre class="text-xs bg-slate-50 p-3 rounded-xl overflow-auto">
{{ a.sra_detail }}
        </pre>
      {% else %}
        <div class="text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SRA</div>
      {% endif %}
    </div>

  </div>
</details>

            <!-- Doctor's Notes -->
            {% if notes and notes|length > 0 %}
              <div class="rounded-2xl bg-sky-50 px-4 py-3">
                <div class="font-semibold text-sky-700 mb-1">Doctor's Notes</div>
                <p class="text-slate-700 whitespace-pre-line">
                  {{ notes[0].note }}
                </p>

                <div class="mt-1 text-xs text-slate-400">
                  {# ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ created_at ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà datetime #}
                  {% if notes[0].created_at and notes[0].created_at.strftime is defined %}
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ notes[0].created_at.strftime("%d/%m/%Y %H:%M") }}
                  {% else %}
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ notes[0].created_at }}
                  {% endif %}
                </div>
              </div>
            {% else %}
              <div class="rounded-2xl bg-slate-50 px-4 py-3 text-slate-500">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Doctor's Notes
              </div>
            {% endif %}

          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="rounded-3xl bg-white shadow-lg border border-dashed border-slate-200 p-10 text-center text-slate-400">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}
