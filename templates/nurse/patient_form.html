{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow rounded-2xl p-8 mt-8">
  <h2 class="text-2xl font-semibold text-indigo-600 mb-6">
    {% if mode == "add" %}เพิ่มผู้ป่วยใหม่{% else %}แก้ไขข้อมูลผู้ป่วย{% endif %}
  </h2>
  <form method="post" class="grid grid-cols-2 gap-4">
    <input name="hn" placeholder="HN" value="{{ patient.hn if patient else '' }}" class="border rounded-lg px-4 py-2">
    <input name="gcn" placeholder="GCN" value="{{ patient.gcn if patient else '' }}" class="border rounded-lg px-4 py-2">
    <input name="name" placeholder="ชื่อ-นามสกุล" value="{{ patient.name if patient else '' }}" class="col-span-2 border rounded-lg px-4 py-2">
    <input name="age" placeholder="อายุ" value="{{ patient.age if patient else '' }}" class="border rounded-lg px-4 py-2">
    <!-- วันเดือนปีเกิด (พ.ศ.) -->
<div class="col-span-2">
  <label class="block text-gray-700 mb-1">วัน/เดือน/ปีเกิด (พ.ศ.)</label>
  <input 
  type="text"
  id="birthdate"
  name="birthdate_th"
  placeholder="วัน/เดือน/พ.ศ."
  value="{% if patient and patient.birthdate %}{{ patient.birthdate.strftime('%d/%m/') }}{{ patient.birthdate.year + 543 }}{% endif %}"
  class="w-full border rounded-lg px-4 py-2"
/>
  <input type="hidden" id="birthdate_ad" name="birthdate">
</div>
    <select name="gender" class="border rounded-lg px-4 py-2">
      <option value="ชาย" {% if patient and patient.gender == 'ชาย' %}selected{% endif %}>ชาย</option>
      <option value="หญิง" {% if patient and patient.gender == 'หญิง' %}selected{% endif %}>หญิง</option>
    </select>
    <input name="disease" placeholder="โรคประจำตัว" value="{{ patient.disease if patient else '' }}" class="col-span-2 border rounded-lg px-4 py-2">

    <select name="risk_level" class="col-span-2 border rounded-lg px-4 py-2">
      <option value="ต่ำ" {% if patient and patient.risk_level == 'ต่ำ' %}selected{% endif %}>เสี่ยงต่ำ</option>
      <option value="ปานกลาง" {% if patient and patient.risk_level == 'ปานกลาง' %}selected{% endif %}>เสี่ยงปานกลาง</option>
      <option value="สูง" {% if patient and patient.risk_level == 'สูง' %}selected{% endif %}>เสี่ยงสูง</option>
    </select>

    

        {% if mode == 'edit' %}
    <!-- การ์ดผลการประเมินล่าสุด (แก้ไขได้) -->
    <div class="col-span-2 mt-6 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-4">
      <div class="flex items-center justify-between mb-3">
        <p class="font-semibold text-slate-800">
          ผลการประเมินล่าสุด (แก้ไขได้หากใส่ผิด)
        </p>
        <p class="text-xs text-slate-500">
          ใส่เฉพาะ “คะแนนรวม” จากแบบประเมินแต่ละแบบ
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- MMSE -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            MMSE-T (0–30)
          </label>
          <input
            type="number"
            name="mmse"
            min="0" max="30"
            value="{{ patient.mmse if patient and patient.mmse is not none else 0 }}"
            class="w-full rounded-xl border border-slate-300 px-4 py-2.5 text-lg
                   focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
            placeholder="เช่น 24">
          <p class="text-xs text-slate-400 mt-1">
            คะแนนสมรรถภาพสมองรวม
          </p>
        </div>

        <!-- TGDS -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            TGDS-15 (0–15)
          </label>
          <input
            type="number"
            name="tgds"
            min="0" max="15"
            value="{{ patient.tgds if patient and patient.tgds is not none else 0 }}"
            class="w-full rounded-xl border border-slate-300 px-4 py-2.5 text-lg
                   focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
            placeholder="เช่น 3">
          <p class="text-xs text-slate-400 mt-1">
            คะแนนภาวะซึมเศร้ารวม
          </p>
        </div>

        <!-- 8Q / SRA -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            8Q / SRA
          </label>
          <input
            type="number"
            name="sra"
            min="0"
            value="{{ patient.sra if patient and patient.sra is not none else 0 }}"
            class="w-full rounded-xl border border-slate-300 px-4 py-2.5 text-lg
                   focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
            placeholder="เช่น 0">
          <p class="text-xs text-slate-400 mt-1">
            คะแนนรวมความเสี่ยงการฆ่าตัวตาย
          </p>
        </div>
      </div>
    </div>
    {% endif %}


    <div class="col-span-2 flex justify-end gap-3 mt-6">
      <a href="{{ url_for('patient_list') }}" class="px-6 py-2 bg-gray-200 rounded-lg">ยกเลิก</a>
      <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">บันทึก</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("birthdate").addEventListener("input", function () {
    const v = this.value.trim();
    if (!v.includes("/")) return;

    const parts = v.split("/");
    if (parts.length !== 3) return;

    let [d, m, y] = parts.map(x => parseInt(x));

    if (y > 2500) y -= 543; // พ.ศ. → ค.ศ.

    const ad = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

    document.getElementById("birthdate_ad").value = ad;
  });
</script>

{% endblock %}
