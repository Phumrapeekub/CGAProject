<!doctype html>

<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• | CGA System</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Sarabun -> Prompt) -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', ui-sans-serif, system-ui; }
    .soft-card { border:1px solid rgba(148,163,184,.25); box-shadow:0 10px 30px rgba(2,6,23,.06); }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-50 min-h-screen">

  <!-- Top bar (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°) -->
  <div class="bg-white border-b border-slate-200">
  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img
        src="{{ url_for('static', filename='image/logo.png') }}"
        alt="CGA Logo"
        class="w-10 h-10 object-contain"
      />
      <div>
        <div class="font-extrabold leading-tight">CGA System</div>
        <div class="text-xs text-slate-500 -mt-0.5">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      </div>
    </div>

    <a href="{{ url_for('dashboard') }}"
       class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-700 font-semibold">
      ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
    </a>
  </div>
</div>


  <main class="max-w-7xl mx-auto px-6 py-8 space-y-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-3xl font-extrabold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h1>
        <p class="text-slate-500 mt-1">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (MMSE / TGDS / 8Q)</p>
      </div>

      <!-- Period badge -->
      <div class="flex items-center gap-2">
        <span class="text-xs px-3 py-1 rounded-full bg-slate-900 text-white font-semibold">
          ‡∏ä‡πà‡∏ß‡∏á: {{ period_label }}
        </span>
      </div>
    </div>

    <!-- Filters -->
    <form method="get" action="{{ url_for('report_summary') }}"
          class="bg-white rounded-3xl soft-card p-5">
      <div class="flex flex-col lg:flex-row lg:items-end gap-4">
        <div class="flex-1">
          <label class="block text-sm font-bold text-slate-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
          <div class="flex flex-wrap gap-2">
            <button type="submit" name="period" value="today"
              class="px-4 py-2 rounded-xl border text-sm font-semibold
              {% if period=='today' %} bg-emerald-50 border-emerald-300 text-emerald-700 {% else %} bg-white border-slate-200 text-slate-700 hover:bg-slate-50 {% endif %}">
              ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </button>

            <button type="submit" name="period" value="week"
              class="px-4 py-2 rounded-xl border text-sm font-semibold
              {% if period=='week' %} bg-violet-50 border-violet-300 text-violet-700 {% else %} bg-white border-slate-200 text-slate-700 hover:bg-slate-50 {% endif %}">
              ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
            </button>

            <button type="submit" name="period" value="month"
              class="px-4 py-2 rounded-xl border text-sm font-semibold
              {% if period=='month' %} bg-orange-50 border-orange-300 text-orange-700 {% else %} bg-white border-slate-200 text-slate-700 hover:bg-slate-50 {% endif %}">
              ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            </button>

            <button type="button" id="btnCustom"
              class="px-4 py-2 rounded-xl border text-sm font-semibold
              {% if period=='custom' %} bg-blue-50 border-blue-300 text-blue-700 {% else %} bg-white border-slate-200 text-slate-700 hover:bg-slate-50 {% endif %}">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏≠‡∏á
            </button>
          </div>
        </div>

        <!-- custom range -->
        <div id="customBox"
             class="w-full lg:w-auto {% if period!='custom' %} hidden {% endif %}">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
              <input type="date" name="start" value="{{ start }}"
                     class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
              <input type="date" name="end" value="{{ end }}"
                     class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-200">
            </div>
          </div>

          <div class="mt-3 flex gap-2 justify-end">
            <button type="submit" name="period" value="custom"
              class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- KPI cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- total -->
      <div class="bg-white rounded-3xl soft-card p-5">
        <div class="flex items-center justify-between">
          <div class="w-10 h-10 rounded-2xl bg-slate-100 grid place-items-center text-slate-600">
            üìå
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-700 font-semibold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        </div>
        <div class="mt-4 text-4xl font-extrabold">{{ kpi.total or 0 }}</div>
        <div class="text-slate-500 text-sm mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
      </div>

      <!-- mmse risk -->
      <div class="bg-white rounded-3xl soft-card p-5">
        <div class="flex items-center justify-between">
          <div class="w-10 h-10 rounded-2xl bg-rose-100 grid place-items-center text-rose-700">
            üß†
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-rose-100 text-rose-700 font-semibold">MMSE</span>
        </div>
        <div class="mt-4 text-4xl font-extrabold">{{ kpi.risk_mmse or 0 }}</div>
        <div class="text-slate-500 text-sm mt-1">‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏¥‡∏î</div>
        <div class="text-xs text-slate-400 mt-2">‡πÄ‡∏Å‡∏ì‡∏ë‡πå: &lt; 24</div>
      </div>

      <!-- tgds risk -->
      <div class="bg-white rounded-3xl soft-card p-5">
        <div class="flex items-center justify-between">
          <div class="w-10 h-10 rounded-2xl bg-amber-100 grid place-items-center text-amber-700">
            ‚òÅÔ∏è
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-700 font-semibold">TGDS</span>
        </div>
        <div class="mt-4 text-4xl font-extrabold">{{ kpi.risk_tgds or 0 }}</div>
        <div class="text-slate-500 text-sm mt-1">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤</div>
        <div class="text-xs text-slate-400 mt-2">‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‚â• 6</div>
      </div>

      <!-- sra risk -->
      <div class="bg-white rounded-3xl soft-card p-5">
        <div class="flex items-center justify-between">
          <div class="w-10 h-10 rounded-2xl bg-emerald-100 grid place-items-center text-emerald-700">
            ‚ö†Ô∏è
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold">8Q</span>
        </div>
        <div class="mt-4 text-4xl font-extrabold">{{ kpi.risk_sra or 0 }}</div>
        <div class="text-slate-500 text-sm mt-1">‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢</div>
        <div class="text-xs text-slate-400 mt-2">‡πÄ‡∏Å‡∏ì‡∏ë‡πå: &gt; 0</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- line chart -->
      <div class="lg:col-span-2 bg-white rounded-3xl soft-card p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-extrabold">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
            <div class="text-slate-500 text-sm">‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
          </div>
        </div>
        <div class="mt-4">
          <canvas id="trendChart" height="120"></canvas>
        </div>

        {% if (trend_labels|length)==0 %}
          <div class="mt-4 text-sm text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div>
        {% endif %}
      </div>

      <!-- donut -->
      <div class="bg-white rounded-3xl soft-card p-5">
        <div class="text-lg font-extrabold">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        <div class="text-slate-500 text-sm">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏î‡πâ‡∏≤‡∏ô vs ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        <div class="mt-4">
          <canvas id="donutChart" height="180"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
          <div class="bg-slate-50 rounded-2xl p-3">
            <div class="text-slate-500 text-xs">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
            <div class="font-extrabold text-lg">{{ donut.at_risk or 0 }}</div>
          </div>
          <div class="bg-slate-50 rounded-2xl p-3">
            <div class="text-slate-500 text-xs">‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
            <div class="font-extrabold text-lg">{{ donut.normalish or 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Urgent table -->
    <div class="bg-white rounded-3xl soft-card p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-lg font-extrabold">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
          <div class="text-slate-500 text-sm">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 8Q (SRA) ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr class="border-b">
              <th class="py-3 pr-4">HN</th>
              <th class="py-3 pr-4">GCN</th>
              <th class="py-3 pr-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th class="py-3 pr-4">‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th class="py-3 pr-4">MMSE</th>
              <th class="py-3 pr-4">TGDS</th>
              <th class="py-3 pr-4">8Q</th>
              <th class="py-3 pr-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
            </tr>
          </thead>
          <tbody class="text-slate-800">
            {% if urgent and urgent|length > 0 %}
              {% for p in urgent %}
                <tr class="border-b last:border-b-0 hover:bg-slate-50">
                  <td class="py-3 pr-4 font-semibold">{{ p.hn }}</td>
                  <td class="py-3 pr-4">{{ p.gcn }}</td>
                  <td class="py-3 pr-4">
                    {{ p.name }} {{ p.surname or "" }}
                  </td>
                  <td class="py-3 pr-4">{{ p.age or "-" }}</td>
                  <td class="py-3 pr-4">{{ p.mmse if p.mmse is not none else "-" }}</td>
                  <td class="py-3 pr-4">{{ p.tgds if p.tgds is not none else "-" }}</td>
                  <td class="py-3 pr-4">
                    <span class="px-3 py-1 rounded-full bg-rose-100 text-rose-700 font-bold">
                      {{ p.sra }}
                    </span>
                  </td>
                  <td class="py-3 pr-4 text-slate-500">
                    {{ p.date_assessed }}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="py-6 text-center text-slate-500">
                  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="text-xs text-slate-400 pb-10">
      *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    </div>
  </main>

  <script>
    const btnCustom = document.getElementById("btnCustom");
    const box = document.getElementById("customBox");
    if (btnCustom) {
      btnCustom.addEventListener("click", () => {
        box.classList.toggle("hidden");
      });
    }

    const raw = document.getElementById("reportData");
    const data = raw ? JSON.parse(raw.textContent) : null;

    const trendLabels = data?.trend_labels || [];
    const trendValues = data?.trend_values || [];
    const donutData = data?.donut || { at_risk: 0, normalish: 0 };

    const ctxTrend = document.getElementById("trendChart");
    if (ctxTrend && trendLabels.length > 0) {
      new Chart(ctxTrend, {
        type: "line",
        data: {
          labels: trendLabels,
          datasets: [{
            label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô",
            data: trendValues,
            tension: 0.35,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    const ctxDonut = document.getElementById("donutChart");
    if (ctxDonut) {
      new Chart(ctxDonut, {
        type: "doughnut",
        data: {
          labels: ["‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", "‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"],
          datasets: [{
            data: [donutData.at_risk || 0, donutData.normalish || 0],
            borderWidth: 0
          }]
        },
        options: {
          plugins: { legend: { position: "bottom" } },
          cutout: "65%"
        }
      });
    }
  </script>

</body>
</html>
